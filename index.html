<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>The Wealth & Health of Nations</title>
  <link rel="stylesheet" type="text/css" href="styles/base.css">
</head>
<body>

  <h2>Making a scatterplot</h2>

  <!-- libraries -->
  <script src="js/d3.v3.min.js"></script>

  <!-- main script -->
  <script>

  // define global variables
  var width = 960;
  var height = 600;
  var radius = 5;
  var year = 2008;
  var indicators = ["income", "lifeExpectancy", "population"];

  // make a nation-based color scale
  var nationColors = d3.scale.category10();

  // TODO: define scales mapping income and life expectancy
  //       to x and y position based on the width and height
  // NOTE: don't try to define the domain until the data is loaded!
  // NOTE: use a log scale for income
  // NOTE: be sure to invert the y range
  // var incomeX = ?
  // var lifeY = ?

  // select the body element a la jquery
  var body = d3.select("body");
  var svg = body.append("svg")
                .attr("height", height)
                .attr("width", width);

  // load the data, calling back our handler function when ready
  d3.json("data/nation_stats.json", function(nations){
    // figure out indicator values for current year
    calcCurrentValues(nations, indicators, year);

    // set domain for color scale based on list of possible regions
    nationColors.domain(calcRegions(nations));

    // set domains for x and y scales based on the min and max values
    // of income and life expectancy indicators across all nations and years
    incomeX.domain(calcExtents(nations, "income")).nice();
    lifeY.domain(calcExtents(nations, "lifeExpectancy")).nice();

    plotCircles(nations, year);
  });

  function calcCurrentValues(nations, indicators, year){
    nations.forEach(function(nation){
      nation.current = {};
      indicators.forEach(function(indicator){
        nation.current[indicator] = getValueFor(nation, indicator, year);
      });
    });
  }

  function getValueFor(nation, indicator, year){
    var items = nation[indicator].filter(function(d){
      return d.year == year;
    })

    return items.length ? items[0].value : null;
  }

  function calcRegions(nations) {
    return d3.nest()

      // aggregate all rows into groups using the region as the group key
      .key(function(d) {
        return d.region;
      })

      // pass our nation rows
      .entries(nations)

      // iterate over the results and collect all the group keys, which
      // map to our region names.
      .map(function(d) {
        return d.key;
      });
  }

  function calcExtents(nations, indicator){
    // get all indicator values for all nations into a single array
    var allValues = nations.map(function(d){
      return d[indicator];
    }).reduce(function(values, current){
       return values.concat(current)
    }, []);

    // return the min and max values using d3's extent helper
    return d3.extent(allValues, function(d){ return d.value });
  }

  function plotCircles(nations) {
    // setup a container for our circles
    var circleGroup = svg.append("g")
      .classed("circles", true);

    // TODO: find nations that have valid data in the current year
    // var validNations = ?

    // bind valid nation data to a d3 selection
    var nationCircles = circleGroup.selectAll(".nation")
      .data(validNations, function(d){
        return d.name;
      });

    // create circle elements for each nation
    nationCircles.enter()
      .append("circle")
      .classed("nation", true)
      .attr("r", radius)
      .attr("cx", function(d){
        // TODO: return the x position based on current income
      })
      .attr("cy", function(d) {
        // TODO: return the y position based on current life expectancy
      })
      .style("fill", function(d) {
        return nationColors(d.region);
      });
  }

  </script>
</body>
</html>